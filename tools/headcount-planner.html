<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headcount Planner v0.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --border-color: #dee2e6;
            --border-highlight: #ced4da;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #868e96;
            --accent-blue: #2563eb;
            --accent-green: #16a34a;
            --accent-red: #dc2626;
            --accent-yellow: #ca8a04;
            --cell-hover: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: inherit;
        }

        input, button, textarea, select {
            font-family: inherit;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 12px 16px;
        }

        .container {
            margin: 0 auto;
        }

        header {
            margin-bottom: 12px;
        }

        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 2px;
            background: linear-gradient(135deg, #1e3a8a 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 11px;
        }

        #subheader-input::placeholder {
            color: var(--text-muted);
            opacity: 1;
        }

        .url-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .url-section label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            font-family: 'Space Grotesk', sans-serif;
        }

        .copy-btn {
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: #2563eb;
        }

        .copy-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .copy-btn.copied {
            background: var(--accent-green);
        }

        .url-note {
            font-size: 9px;
            color: var(--text-muted);
            flex: 1;
        }

        .table-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: visible;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: inline-block;
            min-width: 100%;
        }

        .table-scroll {
            overflow: visible;
        }

        table {
            border-collapse: collapse;
            min-width: 350px;
            background: var(--bg-secondary);
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            height: 28px;
            min-width: 50px;
            font-size: 11px;
        }

        td {
            background: var(--bg-secondary);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 10px;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
        }

        th:first-child {
            text-align: center;
            min-width: 30px;
            width: 30px;
        }

        th:nth-child(2) {
            text-align: left;
            padding-left: 10px;
            min-width: 180px;
        }

        .index-row th {
            background: var(--bg-tertiary);
            height: 18px;
            font-size: 9px;
            color: var(--text-muted);
            font-weight: 500;
            padding: 2px 4px;
        }

        .index-cell {
            background: var(--bg-tertiary) !important;
            color: var(--text-muted);
            font-size: 9px;
            font-weight: 500;
            min-width: 30px !important;
            width: 30px;
            text-align: center;
            padding: 4px !important;
        }

        td.index-cell {
            border-right: 1px solid var(--border-color);
        }

        .index-header {
            min-width: 30px !important;
            width: 30px;
            font-size: 9px;
            color: var(--text-muted);
            text-align: center;
        }

        .resource-header {
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, #e9ecef 100%);
            color: var(--text-primary);
            font-weight: 600;
        }

        .resource-header th {
            padding: 3px 2px;
            height: 70px;
            vertical-align: middle;
            overflow: visible;
        }

        .resource-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
            overflow: visible;
        }

        .resource-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .resource-name-input {
            background: transparent;
            border: none;
            text-align: center;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            font-weight: 600;
            min-width: 40px;
            padding: 0 2px;
        }

        .resource-name-input:focus {
            outline: none;
            background: var(--cell-hover);
        }

        .resource-move-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 8px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .resource-move-btn:hover {
            color: var(--accent-blue);
        }

        .add-resource-cell {
            background: var(--bg-tertiary);
            min-width: 40px !important;
            cursor: pointer;
        }

        .add-resource-btn {
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text-muted);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-resource-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .resource-delete-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .resource-delete-btn:hover {
            color: var(--accent-red);
        }

        .pie-chart {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: visible;
        }

        .pie-full {
            box-shadow: 0 0 0 2px var(--accent-green);
        }

        .pie-overallocated {
            box-shadow: 0 0 0 2px #991b1b;
        }

        .initiative-cell {
            text-align: left;
            padding: 0;
        }

        .initiative-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: left;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            cursor: text;
        }

        .initiative-input:focus {
            outline: none;
            background: var(--cell-hover);
        }

        .initiative-input.duplicate {
            background: #fecaca !important;
            color: #991b1b;
        }

        .resource-name-input.duplicate {
            background: #fecaca !important;
            color: #991b1b;
        }

        .add-initiative-row td {
            background: var(--bg-tertiary);
        }

        .add-initiative-row td:first-child {
            text-align: left;
            padding-left: 10px;
        }

        .add-btn {
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            padding: 4px 10px;
            color: var(--text-muted);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            padding: 0 2px;
            line-height: 1;
        }

        .delete-btn:hover {
            color: var(--accent-red);
        }

        .move-btn, .clone-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            padding: 0 2px;
            line-height: 1;
        }

        .move-btn:hover {
            color: var(--accent-blue);
        }

        .clone-btn:hover {
            color: var(--accent-green);
        }

        .initiative-cell-content {
            display: flex;
            align-items: center;
        }

        .initiative-cell-content .initiative-input {
            flex: 1;
        }

        .initiative-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 4px;
        }

        .total-cell {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: #0f2057;
            min-width: 40px !important;
        }

        .total-header {
            line-height: 1.2;
            min-width: 40px !important;
        }

        .total-header div:last-child {
            font-size: 12px;
            color: #0f2057;
        }

        .allocation-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px;
            padding: 2px;
            cursor: text;
        }

        .allocation-input:focus {
            outline: none;
            background: var(--cell-hover);
        }

        td:has(.allocation-input:focus) {
            box-shadow: inset 0 0 0 2px var(--accent-blue);
        }

        .empty-state {
            padding: 32px 16px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 12px;
            line-height: 1.5;
        }

        .legend {
            display: flex;
            gap: 16px;
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .legend-item svg {
            flex-shrink: 0;
        }

        footer {
            margin-top: 16px;
            text-align: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .url-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            body {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: baseline; gap: 12px; flex: 1;">
                <h1>Headcount Planner v0.3</h1>
                <input type="text" id="subheader-input" placeholder="<Enter Your Plan Title Here>" style="
                    background: transparent;
                    border: none;
                    padding: 4px 8px;
                    color: var(--text-primary);
                    font-family: 'Space Grotesk', sans-serif;
                    font-size: 24px;
                    font-weight: 600;
                    flex: 1;
                    min-width: 350px;
                    outline: none;
                ">
            </div>
            <p class="subtitle">
                A lightweight resource allocation tool. All data is encoded in the URL â€” no server storage required. Share URLs to collaborate. Self-hostable for enterprise use.
            </p>
        </header>

        <div class="url-section">
            <label id="url-label">Shareable URL</label>
            <span class="url-note">Note: URL should be &lt;80,000 chars for most browsers. Microsoft Edge/IE has a shorter limit (~2,083 chars).</span>
            <button class="copy-btn" id="copy-btn">Copy URL</button>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <div id="table-container"></div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <svg width="28" height="28" viewBox="0 0 35 35" style="overflow:visible">
                    <circle cx="17.5" cy="17.5" r="16.5" fill="#9ca3af" stroke="#6b7280" stroke-width="1"/>
                    <text x="17.5" y="17.5" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="11" font-family="Space Grotesk, sans-serif" font-weight="700">0%</text>
                </svg>
                <span>Unallocated</span>
            </div>
            <div class="legend-item">
                <svg width="28" height="28" viewBox="0 0 35 35" style="overflow:visible">
                    <circle cx="17.5" cy="17.5" r="16.5" fill="#0f2057"/>
                    <text x="17.5" y="17.5" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="11" font-family="Space Grotesk, sans-serif" font-weight="700">50%</text>
                </svg>
                <span>Allocated</span>
            </div>
            <div class="legend-item">
                <svg width="28" height="28" viewBox="0 0 35 35" style="box-shadow: 0 0 0 2px #16a34a; border-radius: 50%; overflow:visible">
                    <circle cx="17.5" cy="17.5" r="16.5" fill="#0f2057"/>
                    <text x="17.5" y="17.5" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="11" font-family="Space Grotesk, sans-serif" font-weight="700">100%</text>
                </svg>
                <span>Fully allocated</span>
            </div>
            <div class="legend-item">
                <svg width="28" height="28" viewBox="0 0 35 35" style="box-shadow: 0 0 0 2px #991b1b; border-radius: 50%; overflow:visible">
                    <circle cx="17.5" cy="17.5" r="16.5" fill="#991b1b"/>
                    <text x="17.5" y="17.5" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="11" font-family="Space Grotesk, sans-serif" font-weight="700">120%</text>
                </svg>
                <span>Over-allocated</span>
            </div>
        </div>

        <footer>
            Developed by <a href="https://lijianliu.github.io/" target="_blank">Lijian Liu</a> Â· Updated on Jan 26, 2026
        </footer>
    </div>

    <script>
        // State management
        let state = {
            resources: [],
            initiatives: [],
            allocations: {}, // key: "initiative_resource", value: number
            subheader: ''
        };

        // DOM elements
        const subheaderInput = document.getElementById('subheader-input');
        const tableContainer = document.getElementById('table-container');
        const urlLabel = document.getElementById('url-label');
        const copyBtn = document.getElementById('copy-btn');
        
        // Store current URL for clipboard
        let currentUrl = '';

        // Initialize from URL
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            const resourcesParam = params.get('resources');
            const initiativesParam = params.get('initiatives');
            const allocationsParam = params.get('allocations');
            const subheaderParam = params.get('subheader');

            if (subheaderParam) {
                state.subheader = decodeURIComponent(subheaderParam);
                subheaderInput.value = state.subheader;
            }

            if (resourcesParam) {
                state.resources = resourcesParam.split(',').map(r => decodeURIComponent(r.trim())).filter(r => r);
            } else {
                // Default sample resources
                state.resources = ['Alice', 'Bob', 'Charlie', 'Diana'];
            }

            if (initiativesParam) {
                state.initiatives = initiativesParam.split(',').map(i => decodeURIComponent(i.trim())).filter(i => i);
            } else {
                // Default sample initiatives
                state.initiatives = ['Q1 Product Launch', 'Platform Migration', 'Customer Support', 'Technical Debt Reduction'];
            }

            if (allocationsParam) {
                try {
                    state.allocations = JSON.parse(decodeURIComponent(allocationsParam));
                } catch (e) {
                    state.allocations = {};
                }
            }

            renderTable();
        }

        // Generate shareable URL
        function generateURL() {
            // Try to get current URL, fallback to placeholder
            let baseURL;
            try {
                baseURL = window.location.origin + window.location.pathname;
                // If we're in an iframe with about:srcdoc, use fallback
                if (baseURL.includes('about:srcdoc') || baseURL === 'null' || !baseURL || baseURL === 'null/') {
                    baseURL = 'https://yoursite.com/headcount-planner.html';
                }
            } catch (e) {
                baseURL = 'https://yoursite.com/headcount-planner.html';
            }
            
            const parts = [];
            
            if (state.subheader) {
                parts.push('subheader=' + encodeURIComponent(state.subheader));
            }
            
            if (state.resources.length > 0) {
                parts.push('resources=' + state.resources.map(r => encodeURIComponent(r)).join(','));
            }
            
            if (state.initiatives.length > 0) {
                parts.push('initiatives=' + state.initiatives.map(i => encodeURIComponent(i)).join(','));
            }
            
            if (Object.keys(state.allocations).length > 0) {
                // Clean up allocations - remove zero values and invalid keys
                const cleanAllocations = {};
                for (const [key, value] of Object.entries(state.allocations)) {
                    if (value && value !== 0) {
                        const [initiative, resource] = key.split('|||');
                        if (state.initiatives.includes(initiative) && state.resources.includes(resource)) {
                            cleanAllocations[key] = value;
                        }
                    }
                }
                state.allocations = cleanAllocations;
                
                if (Object.keys(cleanAllocations).length > 0) {
                    parts.push('allocations=' + encodeURIComponent(JSON.stringify(cleanAllocations)));
                }
            }

            return parts.length > 0 ? `${baseURL}?${parts.join('&')}` : baseURL;
        }

        // Update URL display
        function updateURLDisplay() {
            const url = generateURL();
            currentUrl = url;
            const len = url.length;
            const lenFormatted = len.toLocaleString();
            
            // Update label with length and color warning
            urlLabel.textContent = `Shareable URL (length=${lenFormatted} chars)`;
            
            if (len > 80000) {
                urlLabel.style.color = '#dc2626'; // Red - exceeds most browser limits
            } else if (len > 2083) {
                urlLabel.style.color = '#ca8a04'; // Yellow - exceeds MS Edge/IE limit
            } else {
                urlLabel.style.color = ''; // Default
            }
            
            // Update browser address bar
            try {
                const hasErrors = document.querySelectorAll('.initiative-input.duplicate').length > 0 ||
                                  document.querySelectorAll('.resource-name-input.duplicate').length > 0;
                if (!hasErrors) {
                    history.replaceState(null, '', url);
                }
            } catch (e) {
                // Ignore errors in iframe or restricted environments
            }
        }

        // Copy URL to clipboard
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(currentUrl);
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy URL';
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy URL';
                    copyBtn.classList.remove('copied');
                }, 2000);
            }
        });

        // Get allocation value
        function getAllocation(initiative, resource) {
            const key = `${initiative}|||${resource}`;
            return state.allocations[key] || 0;
        }

        // Set allocation value
        function setAllocation(initiative, resource, value) {
            const key = `${initiative}|||${resource}`;
            const numValue = parseFloat(value) || 0;
            
            if (numValue === 0) {
                delete state.allocations[key];
            } else {
                state.allocations[key] = numValue;
            }
            
            updateURLDisplay();
            updateTotalsAndPies();
        }

        // Update only totals and pie charts without re-rendering table
        function updateTotalsAndPies() {
            // Update initiative totals
            const totalCells = document.querySelectorAll('.total-cell');
            state.initiatives.forEach((initiative, idx) => {
                if (totalCells[idx]) {
                    totalCells[idx].textContent = formatNumber(getInitiativeTotal(initiative));
                }
            });

            // Update grand total in header
            const totalHeader = document.querySelector('.total-header');
            if (totalHeader) {
                totalHeader.innerHTML = `<div>Total</div><div>${formatNumber(getGrandTotal())}</div>`;
            }

            // Update pie charts in header (only update the SVG, preserve buttons)
            const headerCells = document.querySelectorAll('.resource-cell');
            state.resources.forEach((resource, idx) => {
                if (headerCells[idx]) {
                    const allocated = getAllocatedForResource(resource);
                    const oldSvg = headerCells[idx].querySelector('svg');
                    if (oldSvg) {
                        const newPieChart = createPieChart(allocated);
                        const temp = document.createElement('div');
                        temp.innerHTML = newPieChart;
                        const newSvg = temp.querySelector('svg');
                        oldSvg.replaceWith(newSvg);
                    }
                }
            });
        }

        // Calculate unallocated for a resource
        function getUnallocated(resource) {
            let total = 0;
            for (const initiative of state.initiatives) {
                total += getAllocation(initiative, resource);
            }
            return Math.round((1 - total) * 1000) / 1000; // Avoid floating point issues
        }

        // Check for duplicate or empty initiative names and highlight
        function checkInitiativeDuplicates() {
            const inputs = document.querySelectorAll('.initiative-input');
            const names = [];
            
            // Collect all current names from inputs
            inputs.forEach(input => {
                names.push(input.value.trim().toLowerCase());
            });
            
            // Find duplicates and empty names
            const errorIndices = new Set();
            
            // Check for empty/whitespace names
            for (let i = 0; i < names.length; i++) {
                if (!names[i]) {
                    errorIndices.add(i);
                }
            }
            
            // Check for duplicates
            for (let i = 0; i < names.length; i++) {
                if (!names[i]) continue;
                for (let j = i + 1; j < names.length; j++) {
                    if (names[i] === names[j]) {
                        errorIndices.add(i);
                        errorIndices.add(j);
                    }
                }
            }
            
            // Apply/remove duplicate class
            inputs.forEach((input, idx) => {
                if (errorIndices.has(idx)) {
                    input.classList.add('duplicate');
                } else {
                    input.classList.remove('duplicate');
                }
            });

            updateCopyButtonState();
            return errorIndices.size > 0;
        }

        // Check for duplicate or empty resource names and highlight
        function checkResourceDuplicates() {
            const inputs = document.querySelectorAll('.resource-name-input');
            const names = [];
            
            // Collect all current names from inputs
            inputs.forEach(input => {
                names.push(input.value.trim().toLowerCase());
            });
            
            // Find duplicates and empty names
            const errorIndices = new Set();
            
            // Check for empty/whitespace names
            for (let i = 0; i < names.length; i++) {
                if (!names[i]) {
                    errorIndices.add(i);
                }
            }
            
            // Check for duplicates
            for (let i = 0; i < names.length; i++) {
                if (!names[i]) continue;
                for (let j = i + 1; j < names.length; j++) {
                    if (names[i] === names[j]) {
                        errorIndices.add(i);
                        errorIndices.add(j);
                    }
                }
            }
            
            // Apply/remove duplicate class
            inputs.forEach((input, idx) => {
                if (errorIndices.has(idx)) {
                    input.classList.add('duplicate');
                } else {
                    input.classList.remove('duplicate');
                }
            });

            updateCopyButtonState();
            return errorIndices.size > 0;
        }

        // Update copy button state based on duplicates or empty names
        function updateCopyButtonState() {
            const hasInitErrors = document.querySelectorAll('.initiative-input.duplicate').length > 0;
            const hasResErrors = document.querySelectorAll('.resource-name-input.duplicate').length > 0;
            
            if (hasInitErrors || hasResErrors) {
                copyBtn.disabled = true;
                copyBtn.title = 'Fix duplicate or empty names first';
            } else {
                copyBtn.disabled = false;
                copyBtn.title = '';
            }
        }

        // Calculate total allocation for an initiative
        function getInitiativeTotal(initiative) {
            let total = 0;
            for (const resource of state.resources) {
                total += getAllocation(initiative, resource);
            }
            return Math.round(total * 1000) / 1000;
        }

        // Render the table
        function renderTable() {
            if (state.resources.length === 0) {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <p>Add resources to start planning.</p>
                    </div>
                `;
                return;
            }

            let html = '<table>';
            
            // Index row for resources
            html += '<thead><tr class="index-row">';
            html += '<th class="index-cell"></th>'; // Empty for index column
            html += '<th class="index-cell"></th>'; // Empty for Initiative header
            html += '<th class="index-cell"></th>'; // Empty for Total header
            for (let resIdx = 0; resIdx < state.resources.length; resIdx++) {
                html += `<th class="index-cell">${resIdx + 1}</th>`;
            }
            html += '<th class="index-cell"></th>'; // Empty for add column
            html += '</tr>';
            
            // Header row - Resource names with pie charts
            html += '<tr class="resource-header">';
            html += '<th class="index-header">#</th>';
            html += '<th>Initiative</th>';
            const grandTotal = getGrandTotal();
            html += `<th class="total-header"><div>Total</div><div>${formatNumber(grandTotal)}</div></th>`;
            for (let resIdx = 0; resIdx < state.resources.length; resIdx++) {
                const resource = state.resources[resIdx];
                const allocated = getAllocatedForResource(resource);
                const pieChart = createPieChart(allocated);
                html += `<th><div class="resource-cell"><div class="resource-buttons"><button class="resource-move-btn" data-res-idx="${resIdx}" data-dir="left" title="Move left">â—€</button><button class="resource-move-btn" data-res-idx="${resIdx}" data-dir="right" title="Move right">â–¶</button><button class="resource-delete-btn" data-res-idx="${resIdx}" title="Delete">Ã—</button></div><input type="text" class="resource-name-input" data-res-idx="${resIdx}" data-original-name="${escapeHtml(resource)}" value="${escapeHtml(resource)}">${pieChart}</div></th>`;
            }
            html += `<th class="add-resource-cell"><button class="add-resource-btn" id="add-resource-btn">+ Add</button></th>`;
            html += '</tr></thead>';

            html += '<tbody>';

            // Initiative rows
            for (let initIdx = 0; initIdx < state.initiatives.length; initIdx++) {
                const initiative = state.initiatives[initIdx];
                html += '<tr>';
                html += `<td class="index-cell">${initIdx + 1}</td>`;
                html += `<td class="initiative-cell"><div class="initiative-cell-content"><input type="text" class="initiative-input" data-init-idx="${initIdx}" data-original-name="${escapeHtml(initiative)}" value="${escapeHtml(initiative)}"><div class="initiative-actions"><button class="move-btn" data-init-idx="${initIdx}" data-dir="up" title="Move up">â–²</button><button class="move-btn" data-init-idx="${initIdx}" data-dir="down" title="Move down">â–¼</button><button class="clone-btn" data-init-idx="${initIdx}" title="Clone">â§‰</button><button class="delete-btn" data-init-idx="${initIdx}" title="Delete">Ã—</button></div></div></td>`;
                html += `<td class="total-cell">${formatNumber(getInitiativeTotal(initiative))}</td>`;
                
                for (let resIdx = 0; resIdx < state.resources.length; resIdx++) {
                    const resource = state.resources[resIdx];
                    const value = getAllocation(initiative, resource);
                    const displayValue = value === 0 ? '' : formatNumber(value);
                    html += `<td><input type="text" class="allocation-input" data-r="${initIdx}" data-c="${resIdx}" value="${displayValue}" placeholder="0"></td>`;
                }
                html += '<td class="add-resource-cell"></td>';
                html += '</tr>';
            }

            // Add initiative row
            html += '<tr class="add-initiative-row">';
            html += '<td class="index-cell"></td>';
            html += `<td><button class="add-btn" id="add-initiative-btn">+ Add Initiative</button></td>`;
            html += `<td class="add-resource-cell"></td>`;
            for (let i = 0; i < state.resources.length; i++) {
                html += '<td class="add-resource-cell"></td>';
            }
            html += '<td class="add-resource-cell"></td>';
            html += '</tr>';

            html += '</tbody></table>';
            tableContainer.innerHTML = html;

            // Add event listeners to allocation inputs
            document.querySelectorAll('.allocation-input').forEach(input => {
                input.addEventListener('change', handleAllocationChange);
                input.addEventListener('input', handleAllocationInput);
                input.addEventListener('keydown', handleKeyNavigation);
            });

            // Add event listeners to initiative inputs
            document.querySelectorAll('.initiative-input').forEach(input => {
                input.addEventListener('change', handleInitiativeRename);
                input.addEventListener('input', (e) => {
                    checkInitiativeDuplicates();
                    handleInitiativeInputRealtime(e);
                });
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteInitiative);
            });

            // Add event listeners to move buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.addEventListener('click', handleMoveInitiative);
            });

            // Add event listeners to clone buttons
            document.querySelectorAll('.clone-btn').forEach(btn => {
                btn.addEventListener('click', handleCloneInitiative);
            });

            // Add event listener to add button
            document.getElementById('add-initiative-btn').addEventListener('click', handleAddInitiative);

            // Add event listeners to resource move buttons
            document.querySelectorAll('.resource-move-btn').forEach(btn => {
                btn.addEventListener('click', handleMoveResource);
            });

            // Add event listeners to resource delete buttons
            document.querySelectorAll('.resource-delete-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteResource);
            });

            // Add event listeners to resource name inputs
            document.querySelectorAll('.resource-name-input').forEach(input => {
                input.addEventListener('change', handleResourceRename);
                input.addEventListener('input', (e) => {
                    checkResourceDuplicates();
                    handleResourceInputRealtime(e);
                    autoResizeInput(e.target);
                });
                autoResizeInput(input); // Initial resize
            });

            // Add event listener to add resource button
            document.getElementById('add-resource-btn').addEventListener('click', handleAddResource);

            // Run initial duplicate checks
            checkInitiativeDuplicates();
            checkResourceDuplicates();
            
            // Always update URL after rendering
            updateURLDisplay();
        }

        // Handle arrow key navigation
        function handleKeyNavigation(e) {
            if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Enter') {
                return;
            }

            const input = e.target;
            const row = parseInt(input.dataset.r, 10);
            const col = parseInt(input.dataset.c, 10);
            const numRows = state.initiatives.length;
            const numCols = state.resources.length;

            let newRow = row;
            let newCol = col;

            if (e.key === 'ArrowUp') {
                newRow = row - 1;
            } else if (e.key === 'ArrowDown' || e.key === 'Enter') {
                newRow = row + 1;
            } else if (e.key === 'ArrowLeft') {
                newCol = col - 1;
            } else if (e.key === 'ArrowRight') {
                newCol = col + 1;
            }

            // Check bounds
            if (newRow < 0 || newRow >= numRows || newCol < 0 || newCol >= numCols) {
                return;
            }

            // Find and focus the new cell
            const newInput = document.querySelector(`input[data-r="${newRow}"][data-c="${newCol}"]`);
            if (newInput) {
                e.preventDefault();
                newInput.focus();
                newInput.select();
            }
        }

        // Get total allocated for a resource
        function getAllocatedForResource(resource) {
            let total = 0;
            for (const initiative of state.initiatives) {
                total += getAllocation(initiative, resource);
            }
            return Math.round(total * 1000) / 1000;
        }

        // Get grand total of all allocations
        function getGrandTotal() {
            let total = 0;
            for (const initiative of state.initiatives) {
                for (const resource of state.resources) {
                    total += getAllocation(initiative, resource);
                }
            }
            return Math.round(total * 1000) / 1000;
        }

        // Create SVG pie chart with text inside
        function createPieChart(allocated) {
            const size = 35;
            const radius = size / 2;
            const cx = radius;
            const cy = radius;
            
            // Clamp allocated for display purposes
            const displayAllocated = Math.min(allocated, 1);
            const unallocated = Math.max(0, 1 - allocated);
            
            // Colors - darker blue and red for white text readability
            const allocatedColor = allocated > 1 ? '#991b1b' : '#0f2057';
            const unallocatedColor = '#9ca3af';
            
            // Text to display
            let displayText = '';
            if (allocated === 0) {
                displayText = '0%';
            } else if (allocated === 1) {
                displayText = '100%';
            } else if (allocated > 1) {
                displayText = Math.round(allocated * 100) + '%';
            } else {
                displayText = Math.round(allocated * 100) + '%';
            }
            
            const textColor = '#fff';
            const fontSize = '11';
            
            // If fully unallocated
            if (allocated === 0) {
                return `<svg class="pie-chart" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="overflow:visible">
                    <circle cx="${cx}" cy="${cy}" r="${radius - 1}" fill="${unallocatedColor}" stroke="#6b7280" stroke-width="1"/>
                    <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" fill="${textColor}" font-size="${fontSize}" font-family="Space Grotesk, sans-serif" font-weight="700">${displayText}</text>
                </svg>`;
            }
            
            // If fully allocated or over
            if (allocated >= 1) {
                let extraClass = '';
                if (allocated > 1) {
                    extraClass = ' pie-overallocated';
                } else if (allocated === 1) {
                    extraClass = ' pie-full';
                }
                return `<svg class="pie-chart${extraClass}" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="overflow:visible">
                    <circle cx="${cx}" cy="${cy}" r="${radius - 1}" fill="${allocatedColor}"/>
                    <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" fill="${textColor}" font-size="${fontSize}" font-family="Space Grotesk, sans-serif" font-weight="700">${displayText}</text>
                </svg>`;
            }
            
            // Partial allocation - draw pie slice
            const angle = displayAllocated * 360;
            const startAngle = -90; // Start from top
            const endAngle = startAngle + angle;
            
            const startRad = (startAngle * Math.PI) / 180;
            const endRad = (endAngle * Math.PI) / 180;
            
            const r = radius - 1;
            const x1 = cx + r * Math.cos(startRad);
            const y1 = cy + r * Math.sin(startRad);
            const x2 = cx + r * Math.cos(endRad);
            const y2 = cy + r * Math.sin(endRad);
            
            const largeArc = angle > 180 ? 1 : 0;
            
            const pathData = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;
            
            return `<svg class="pie-chart" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="overflow:visible">
                <circle cx="${cx}" cy="${cy}" r="${r}" fill="${unallocatedColor}"/>
                <path d="${pathData}" fill="${allocatedColor}"/>
                <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" fill="${textColor}" font-size="${fontSize}" font-family="Space Grotesk, sans-serif" font-weight="700">${displayText}</text>
            </svg>`;
        }

        // Handle allocation input change (on blur/change - saves to state and URL)
        function handleAllocationChange(e) {
            const input = e.target;
            const row = parseInt(input.dataset.r, 10);
            const col = parseInt(input.dataset.c, 10);

            const initiative = state.initiatives[row];
            const resource = state.resources[col];
            let value = input.value.trim();
            
            // Allow percentage input
            if (value.endsWith('%')) {
                value = parseFloat(value) / 100;
            } else {
                value = parseFloat(value) || 0;
            }
            
            setAllocation(initiative, resource, value);
        }

        // Handle allocation input (real-time updates while typing)
        function handleAllocationInput(e) {
            const input = e.target;
            const row = parseInt(input.dataset.r, 10);
            const col = parseInt(input.dataset.c, 10);

            const initiative = state.initiatives[row];
            const resource = state.resources[col];
            let value = input.value.trim();
            
            // Allow percentage input
            if (value.endsWith('%')) {
                value = parseFloat(value) / 100;
            } else {
                value = parseFloat(value) || 0;
            }
            
            // Update state
            const key = `${initiative}|||${resource}`;
            if (value === 0) {
                delete state.allocations[key];
            } else {
                state.allocations[key] = value;
            }
            
            // Update visuals and URL
            updateTotalsAndPies();
            updateURLDisplay();
        }

        // Handle initiative rename
        function handleInitiativeRename(e) {
            const input = e.target;
            const initIdx = parseInt(input.dataset.initIdx, 10);
            const originalName = input.dataset.originalName;
            const newName = input.value.trim();

            if (!newName) {
                input.value = originalName;
                checkInitiativeDuplicates();
                return;
            }

            if (newName === originalName) {
                return;
            }

            // Update allocations to use new name
            const newAllocations = {};
            for (const [key, value] of Object.entries(state.allocations)) {
                const [initiative, resource] = key.split('|||');
                if (initiative === originalName) {
                    newAllocations[`${newName}|||${resource}`] = value;
                } else {
                    newAllocations[key] = value;
                }
            }
            state.allocations = newAllocations;

            // Update initiative name
            state.initiatives[initIdx] = newName;
            input.dataset.originalName = newName;
            
            updateURLDisplay();
            updateTotalsAndPies();
        }

        // Handle initiative input in real-time (update URL while typing)
        function handleInitiativeInputRealtime(e) {
            const hasErrors = document.querySelectorAll('.initiative-input.duplicate').length > 0 ||
                              document.querySelectorAll('.resource-name-input.duplicate').length > 0;
            
            if (!hasErrors) {
                const input = e.target;
                const initIdx = parseInt(input.dataset.initIdx, 10);
                const originalName = input.dataset.originalName;
                const newName = input.value.trim();

                if (newName && newName !== originalName) {
                    // Update allocations
                    const newAllocs = {};
                    for (const [key, value] of Object.entries(state.allocations)) {
                        const [initiative, resource] = key.split('|||');
                        if (initiative === originalName) {
                            newAllocs[`${newName}|||${resource}`] = value;
                        } else {
                            newAllocs[key] = value;
                        }
                    }
                    state.allocations = newAllocs;
                    state.initiatives[initIdx] = newName;
                    input.dataset.originalName = newName;
                }
                
                updateURLDisplay();
            }
        }

        // Handle resource input in real-time (update URL while typing)
        function handleResourceInputRealtime(e) {
            const hasErrors = document.querySelectorAll('.initiative-input.duplicate').length > 0 ||
                              document.querySelectorAll('.resource-name-input.duplicate').length > 0;
            
            if (!hasErrors) {
                const input = e.target;
                const resIdx = parseInt(input.dataset.resIdx, 10);
                const originalName = input.dataset.originalName;
                const newName = input.value.trim();

                if (newName && newName !== originalName) {
                    // Update allocations
                    const newAllocs = {};
                    for (const [key, value] of Object.entries(state.allocations)) {
                        const [initiative, resource] = key.split('|||');
                        if (resource === originalName) {
                            newAllocs[`${initiative}|||${newName}`] = value;
                        } else {
                            newAllocs[key] = value;
                        }
                    }
                    state.allocations = newAllocs;
                    state.resources[resIdx] = newName;
                    input.dataset.originalName = newName;
                }
                
                updateURLDisplay();
            }
        }

        // Handle delete initiative
        function handleDeleteInitiative(e) {
            const btn = e.currentTarget;
            const initIdx = parseInt(btn.dataset.initIdx, 10);
            const initiative = state.initiatives[initIdx];

            // Remove allocations for this initiative
            const newAllocations = {};
            for (const [key, value] of Object.entries(state.allocations)) {
                const [init, resource] = key.split('|||');
                if (init !== initiative) {
                    newAllocations[key] = value;
                }
            }
            state.allocations = newAllocations;

            // Remove initiative
            state.initiatives.splice(initIdx, 1);
            
            renderTable();
        }

        // Handle move initiative up or down
        function handleMoveInitiative(e) {
            const btn = e.currentTarget;
            const initIdx = parseInt(btn.dataset.initIdx, 10);
            const direction = btn.dataset.dir;
            
            const newIdx = direction === 'up' ? initIdx - 1 : initIdx + 1;
            
            // Check bounds
            if (newIdx < 0 || newIdx >= state.initiatives.length) {
                return;
            }
            
            // Swap initiatives
            const temp = state.initiatives[initIdx];
            state.initiatives[initIdx] = state.initiatives[newIdx];
            state.initiatives[newIdx] = temp;
            
            renderTable();
        }

        // Handle clone initiative
        function handleCloneInitiative(e) {
            const btn = e.currentTarget;
            const initIdx = parseInt(btn.dataset.initIdx, 10);
            const initiative = state.initiatives[initIdx];
            
            // Generate new name
            let newName = initiative + ' (copy)';
            let counter = 2;
            while (state.initiatives.includes(newName)) {
                newName = initiative + ` (copy ${counter})`;
                counter++;
            }
            
            // Insert after current initiative
            state.initiatives.splice(initIdx + 1, 0, newName);
            
            // Copy allocations
            for (const resource of state.resources) {
                const value = getAllocation(initiative, resource);
                if (value !== 0) {
                    const key = `${newName}|||${resource}`;
                    state.allocations[key] = value;
                }
            }
            
            renderTable();
        }

        // Handle add initiative
        function handleAddInitiative() {
            const newName = `Initiative ${state.initiatives.length + 1}`;
            state.initiatives.push(newName);
            renderTable();

            // Focus the new initiative input
            const inputs = document.querySelectorAll('.initiative-input');
            if (inputs.length > 0) {
                const lastInput = inputs[inputs.length - 1];
                lastInput.focus();
                lastInput.select();
            }
        }

        // Handle move resource left or right
        function handleMoveResource(e) {
            const btn = e.currentTarget;
            const resIdx = parseInt(btn.dataset.resIdx, 10);
            const direction = btn.dataset.dir;
            
            const newIdx = direction === 'left' ? resIdx - 1 : resIdx + 1;
            
            // Check bounds
            if (newIdx < 0 || newIdx >= state.resources.length) {
                return;
            }
            
            // Swap resources
            const temp = state.resources[resIdx];
            state.resources[resIdx] = state.resources[newIdx];
            state.resources[newIdx] = temp;
            
            renderTable();
        }

        // Handle add resource
        function handleAddResource() {
            let newName = `Resource ${state.resources.length + 1}`;
            let counter = 1;
            while (state.resources.includes(newName)) {
                counter++;
                newName = `Resource ${counter}`;
            }
            state.resources.push(newName);
            renderTable();
        }

        // Handle resource rename
        function handleResourceRename(e) {
            const input = e.target;
            const resIdx = parseInt(input.dataset.resIdx, 10);
            const originalName = input.dataset.originalName;
            const newName = input.value.trim();

            if (!newName) {
                input.value = originalName;
                checkResourceDuplicates();
                return;
            }

            if (newName === originalName) {
                return;
            }

            // Update allocations to use new name
            const newAllocations = {};
            for (const [key, value] of Object.entries(state.allocations)) {
                const [initiative, resource] = key.split('|||');
                if (resource === originalName) {
                    newAllocations[`${initiative}|||${newName}`] = value;
                } else {
                    newAllocations[key] = value;
                }
            }
            state.allocations = newAllocations;

            // Update resource name
            state.resources[resIdx] = newName;
            input.dataset.originalName = newName;
            
            updateURLDisplay();
        }

        // Handle delete resource
        function handleDeleteResource(e) {
            const btn = e.currentTarget;
            const resIdx = parseInt(btn.dataset.resIdx, 10);
            const resource = state.resources[resIdx];

            // Remove allocations for this resource
            const newAllocations = {};
            for (const [key, value] of Object.entries(state.allocations)) {
                const [init, res] = key.split('|||');
                if (res !== resource) {
                    newAllocations[key] = value;
                }
            }
            state.allocations = newAllocations;

            // Remove resource
            state.resources.splice(resIdx, 1);
            
            renderTable();
        }

        // Auto-resize input based on content
        function autoResizeInput(input) {
            // Create a temporary span to measure text width
            const span = document.createElement('span');
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            span.style.font = window.getComputedStyle(input).font;
            span.textContent = input.value || input.placeholder || '';
            document.body.appendChild(span);
            const width = Math.max(40, span.offsetWidth + 10);
            document.body.removeChild(span);
            input.style.width = width + 'px';
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (num === 0) return '0';
            if (Number.isInteger(num)) return num.toString();
            return num.toFixed(2).replace(/\.?0+$/, '');
        }

        // Handle subheader change
        function handleSubheaderChange() {
            state.subheader = subheaderInput.value.trim();
            updateURLDisplay();
        }

        // Event listeners
        subheaderInput.addEventListener('input', handleSubheaderChange);

        // Initialize
        loadFromURL();
    </script>
</body>
</html>
