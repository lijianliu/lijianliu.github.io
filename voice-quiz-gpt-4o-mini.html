<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Quiz - Hands Free</title>
    <script src="https://js.puter.com/v2/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --accent-cyan: #00f5d4;
            --accent-magenta: #f72585;
            --accent-yellow: #fee440;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --gradient-glow: linear-gradient(135deg, #00f5d4 0%, #7b2cbf 50%, #f72585 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(0, 245, 212, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(247, 37, 133, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 40% 60% at 50% 50%, rgba(123, 44, 191, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 800;
            background: var(--gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* User Status */
        .user-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: background 0.3s;
        }

        .status-dot.online {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        .status-dot.offline {
            background: var(--accent-red);
        }

        .auth-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            padding: 6px 14px;
            border: 1px solid var(--accent-cyan);
            border-radius: 15px;
            background: transparent;
            color: var(--accent-cyan);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .auth-btn.sign-out {
            border-color: var(--accent-magenta);
            color: var(--accent-magenta);
        }

        .auth-btn.sign-out:hover {
            background: var(--accent-magenta);
            color: white;
        }

        /* Start Screen */
        .start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .start-btn {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 30px 60px;
            border: none;
            border-radius: 50%;
            width: 200px;
            height: 200px;
            cursor: pointer;
            background: var(--gradient-glow);
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 60px rgba(0, 245, 212, 0.3), 0 0 100px rgba(247, 37, 133, 0.2);
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(0, 245, 212, 0.3), 0 0 100px rgba(247, 37, 133, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(0, 245, 212, 0.5), 0 0 120px rgba(247, 37, 133, 0.4); }
        }

        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 100px rgba(0, 245, 212, 0.5), 0 0 150px rgba(247, 37, 133, 0.4);
        }

        .start-instructions {
            margin-top: 40px;
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 2;
        }

        /* Quiz Screen - Fullscreen Mode */
        .quiz-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: var(--bg-dark);
            flex-direction: column;
        }

        /* Floating Question Popup */
        .floating-question {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 94%;
            max-width: 450px;
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 15px 20px;
            z-index: 1001;
            box-shadow: 0 10px 40px rgba(0, 245, 212, 0.3), 0 0 60px rgba(0, 0, 0, 0.8);
        }

        .floating-question .question-counter {
            font-family: 'Space Mono', monospace;
            color: var(--accent-cyan);
            font-size: 0.7rem;
            margin-bottom: 8px;
            letter-spacing: 2px;
            text-align: center;
        }

        .floating-question .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 12px;
            text-align: center;
        }

        .floating-question .status-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            min-height: 50px;
        }

        .floating-question .status-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .floating-question .status-info {
            text-align: left;
        }

        .floating-question .status-text {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .floating-question .user-answer {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-top: 4px;
            font-style: italic;
        }

        .floating-question .feedback-text {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .floating-question .progress-bar {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-glow);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Status Icon States */
        .status-icon.speaking {
            background: rgba(0, 245, 212, 0.2);
            border: 2px solid var(--accent-cyan);
            animation: pulse-cyan 1.5s ease-in-out infinite;
        }

        .status-icon.listening {
            background: rgba(247, 37, 133, 0.2);
            border: 2px solid var(--accent-magenta);
            animation: pulse-magenta 1s ease-in-out infinite;
        }

        .status-icon.correct {
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid var(--accent-green);
        }

        .status-icon.incorrect {
            background: rgba(248, 113, 113, 0.2);
            border: 2px solid var(--accent-red);
        }

        .status-icon.thinking {
            background: rgba(254, 228, 64, 0.2);
            border: 2px solid var(--accent-yellow);
            animation: pulse-yellow 0.8s ease-in-out infinite;
        }

        @keyframes pulse-yellow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(254, 228, 64, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px 5px rgba(254, 228, 64, 0.2); }
        }

        @keyframes pulse-cyan {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 245, 212, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px 5px rgba(0, 245, 212, 0.2); }
        }

        @keyframes pulse-magenta {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px 5px rgba(247, 37, 133, 0.3); }
        }

        .feedback-text.correct { color: var(--accent-green); }
        .feedback-text.incorrect { color: var(--accent-red); }

        /* Wave Animation */
        .wave-animation {
            display: flex;
            justify-content: center;
            gap: 3px;
            height: 30px;
            align-items: center;
        }

        .wave-bar {
            width: 4px;
            height: 15px;
            background: var(--accent-magenta);
            border-radius: 2px;
            animation: wave 0.8s ease-in-out infinite;
        }

        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 25px; }
        }

        /* Speaker Animation */
        .speaker-waves {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .speaker-wave {
            width: 3px;
            background: var(--accent-cyan);
            border-radius: 2px;
            animation: speaker 0.6s ease-in-out infinite;
        }

        .speaker-wave:nth-child(1) { height: 10px; animation-delay: 0s; }
        .speaker-wave:nth-child(2) { height: 18px; animation-delay: 0.1s; }
        .speaker-wave:nth-child(3) { height: 25px; animation-delay: 0.2s; }
        .speaker-wave:nth-child(4) { height: 18px; animation-delay: 0.3s; }
        .speaker-wave:nth-child(5) { height: 10px; animation-delay: 0.4s; }

        @keyframes speaker {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Fullscreen LLM Log */
        .llm-log-fullscreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-top: 180px;
            overflow: hidden;
        }

        .llm-log-header {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.2), rgba(247, 37, 133, 0.2));
            padding: 12px 20px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-cyan);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .llm-stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--accent-cyan);
            font-weight: 700;
        }

        .llm-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
        }

        .llm-log-content::-webkit-scrollbar {
            width: 8px;
        }

        .llm-log-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .llm-log-content::-webkit-scrollbar-thumb {
            background: var(--accent-magenta);
            border-radius: 4px;
        }

        .llm-log-empty {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 60px 20px;
        }

        .llm-log-entry {
            margin-bottom: 10px;
        }

        .llm-log-divider {
            border: none;
            border-top: 2px dashed var(--accent-magenta);
            margin: 25px 0;
            opacity: 0.5;
        }

        .llm-log-label {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }

        .llm-log-input .llm-log-label {
            color: var(--accent-cyan);
        }

        .llm-log-output .llm-log-label {
            color: var(--accent-magenta);
        }

        .llm-log-text {
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.75rem;
        }

        .llm-log-result {
            margin-top: 10px;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 700;
            display: inline-block;
            font-size: 0.8rem;
        }

        .llm-log-result.correct {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        .llm-log-result.incorrect {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        /* LLM Log Meta Info */
        .llm-log-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            background: rgba(0, 245, 212, 0.1);
            border: 1px solid rgba(0, 245, 212, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .meta-label {
            font-size: 0.65rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        /* Grammar Correction */
        .llm-log-grammar {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(254, 228, 64, 0.15);
            border: 1px solid rgba(254, 228, 64, 0.3);
            border-radius: 6px;
        }

        .grammar-label {
            color: var(--accent-yellow);
            font-weight: 700;
            font-size: 0.75rem;
            display: block;
            margin-bottom: 5px;
        }

        .grammar-text {
            color: var(--text-primary);
            font-style: italic;
            font-size: 0.8rem;
        }

        .llm-log-input {
            margin-top: 10px;
        }

        .llm-log-output {
            margin-top: 10px;
        }

        /* Results Screen */
        .results-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .results-card {
            background: var(--bg-card);
            border: 2px solid var(--accent-yellow);
            border-radius: 24px;
            padding: 50px;
        }

        .score-value {
            font-size: 6rem;
            font-weight: 800;
            background: var(--gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-label {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 10px;
            font-size: 1.1rem;
        }

        .score-message {
            margin-top: 30px;
            font-size: 1.3rem;
            color: var(--accent-cyan);
        }

        .restart-btn {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            padding: 18px 40px;
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            background: transparent;
            color: var(--accent-cyan);
            cursor: pointer;
            margin-top: 40px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .history-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            padding: 12px 30px;
            border: 2px solid var(--accent-magenta);
            border-radius: 12px;
            background: transparent;
            color: var(--accent-magenta);
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            display: block;
            width: 100%;
        }

        .history-btn:hover {
            background: var(--accent-magenta);
            color: white;
        }

        /* Inline Results (in floating question area) */
        .results-inline {
            text-align: center;
            padding: 10px 0;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .results-label {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.7rem;
            margin-top: 5px;
        }

        .results-message {
            color: var(--accent-cyan);
            font-size: 1rem;
            margin-top: 10px;
        }

        .restart-btn-inline {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            padding: 10px 25px;
            border: 2px solid var(--accent-cyan);
            border-radius: 10px;
            background: transparent;
            color: var(--accent-cyan);
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .restart-btn-inline:hover {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 600px) {
            .floating-question {
                top: 10px;
                padding: 12px 15px;
            }

            .floating-question .question-text {
                font-size: 1rem;
            }

            .llm-log-fullscreen {
                margin-top: 170px;
            }

            .start-btn {
                width: 160px;
                height: 160px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Voice Quiz</h1>
            <p class="subtitle">100% Hands-Free Experience</p>
            <div class="user-status" id="userStatus">
                <span class="status-dot" id="statusDot"></span>
                <span id="userInfo">Checking login...</span>
                <button class="auth-btn" id="authBtn" onclick="toggleAuth()">Sign In</button>
            </div>
        </header>

        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <button class="start-btn" id="startBtn" onclick="startQuiz()">
                START
            </button>
            <div class="start-instructions">
                ‚Üí Press start and allow microphone<br>
                ‚Üí Listen to each question<br>
                ‚Üí Speak your answer clearly<br>
                ‚Üí Quiz runs automatically!
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="results-card">
                <div class="score-value" id="finalScore">0/5</div>
                <div class="score-label">Final Score</div>
                <div class="score-message" id="scoreMessage"></div>
                <button class="restart-btn" onclick="restartQuiz()">Play Again</button>
                <button class="history-btn" onclick="viewHistory()">View LLM History</button>
            </div>
        </div>
    </div>

    <!-- Quiz Screen - Fullscreen Overlay -->
    <div class="quiz-screen" id="quizScreen">
        <!-- Floating Question Popup -->
        <div class="floating-question" id="floatingQuestion">
            <div class="question-counter" id="questionCounter">Question 1 of 5</div>
            <div class="question-text" id="questionText"></div>
            <div class="status-area">
                <div class="status-icon" id="statusIcon">
                    <div class="speaker-waves" id="speakerWaves">
                        <div class="speaker-wave"></div>
                        <div class="speaker-wave"></div>
                        <div class="speaker-wave"></div>
                        <div class="speaker-wave"></div>
                        <div class="speaker-wave"></div>
                    </div>
                    <div class="wave-animation hidden" id="waveAnimation">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <svg id="checkIcon" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="#4ade80">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <svg id="crossIcon" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="#f87171">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </div>
                <div class="status-info">
                    <div class="status-text" id="statusText">Speaking question...</div>
                    <div class="user-answer" id="userAnswer"></div>
                    <div class="feedback-text" id="feedbackText"></div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Fullscreen LLM Log -->
        <div class="llm-log-fullscreen" id="llmLogPanel">
            <div class="llm-log-header">
                ü§ñ LLM Interactions (GPT-4o-mini via Puter.js)
            </div>
            <div class="llm-stats-bar" id="llmStatsBar">
                <div class="stat-item">
                    <span class="stat-label">üîê Auth:</span>
                    <span class="stat-value" id="statAuth">Checking...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìû Calls:</span>
                    <span class="stat-value" id="statCalls">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üì• In:</span>
                    <span class="stat-value" id="statTokensIn">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üì§ Out:</span>
                    <span class="stat-value" id="statTokensOut">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üéüÔ∏è Total:</span>
                    <span class="stat-value" id="statTokensTotal">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚è±Ô∏è Avg:</span>
                    <span class="stat-value" id="statAvgTime">0ms</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìù Fixes:</span>
                    <span class="stat-value" id="statGrammarFixes">0</span>
                </div>
            </div>
            <div class="llm-log-content" id="llmLogContent">
                <div class="llm-log-empty">LLM interactions will appear here as you answer questions...<br><br>Scroll freely to review history!</div>
            </div>
        </div>
    </div>

    <script>
        // Quiz Questions
        const quizQuestions = [
            {
                question: "What is the capital city of France?",
                answer: "paris",
                acceptedAnswers: ["paris", "paris france", "it's paris", "the answer is paris"]
            },
            {
                question: "How many planets are in our solar system?",
                answer: "eight",
                acceptedAnswers: ["eight", "8", "eight planets", "there are eight", "it's eight"]
            },
            {
                question: "What color do you get when you mix red and blue?",
                answer: "purple",
                acceptedAnswers: ["purple", "violet", "it's purple", "you get purple"]
            },
            {
                question: "What is the largest mammal on Earth?",
                answer: "blue whale",
                acceptedAnswers: ["blue whale", "the blue whale", "whale", "a blue whale", "it's the blue whale"]
            },
            {
                question: "In what year did World War Two end?",
                answer: "1945",
                acceptedAnswers: ["1945", "nineteen forty five", "nineteen forty-five", "it ended in 1945"]
            }
        ];

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
        }
        
        let isProcessingAnswer = false;

        // Speech Synthesis Setup
        const synth = window.speechSynthesis;

        // State
        let currentQuestion = 0;
        let score = 0;
        let userAnswer = '';
        let quizActive = false;
        
        // LLM Stats
        let llmStats = {
            totalCalls: 0,
            totalInputTokens: 0,
            totalOutputTokens: 0,
            totalResponseTime: 0,
            grammarCorrections: 0,
            authInfo: 'Checking...'
        };

        // DOM Elements
        const startScreen = document.getElementById('startScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const questionText = document.getElementById('questionText');
        const questionCounter = document.getElementById('questionCounter');
        const progressFill = document.getElementById('progressFill');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const userAnswerEl = document.getElementById('userAnswer');
        const feedbackText = document.getElementById('feedbackText');
        const speakerWaves = document.getElementById('speakerWaves');
        const waveAnimation = document.getElementById('waveAnimation');
        const checkIcon = document.getElementById('checkIcon');
        const crossIcon = document.getElementById('crossIcon');

        // Update stats bar display
        function updateStatsBar() {
            document.getElementById('statAuth').textContent = llmStats.authInfo;
            document.getElementById('statCalls').textContent = llmStats.totalCalls;
            document.getElementById('statTokensIn').textContent = `~${llmStats.totalInputTokens}`;
            document.getElementById('statTokensOut').textContent = `~${llmStats.totalOutputTokens}`;
            document.getElementById('statTokensTotal').textContent = `~${llmStats.totalInputTokens + llmStats.totalOutputTokens}`;
            document.getElementById('statAvgTime').textContent = llmStats.totalCalls > 0 
                ? `${Math.round(llmStats.totalResponseTime / llmStats.totalCalls)}ms` 
                : '0ms';
            document.getElementById('statGrammarFixes').textContent = llmStats.grammarCorrections;
        }
        
        // Reset stats for new quiz
        function resetStats() {
            llmStats.totalCalls = 0;
            llmStats.totalInputTokens = 0;
            llmStats.totalOutputTokens = 0;
            llmStats.totalResponseTime = 0;
            llmStats.grammarCorrections = 0;
            updateStatsBar();
        }

        // Log LLM interaction to the panel
        function logLLMInteraction(data) {
            const logContent = document.getElementById('llmLogContent');
            
            // Remove empty message if present
            const emptyMsg = logContent.querySelector('.llm-log-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            // Update global stats
            llmStats.totalCalls++;
            llmStats.totalInputTokens += data.tokens.input;
            llmStats.totalOutputTokens += data.tokens.output;
            llmStats.totalResponseTime += data.responseTime;
            llmStats.authInfo = data.authInfo;
            if (data.grammarIssue && data.grammarCorrection) {
                llmStats.grammarCorrections++;
            }
            updateStatsBar();
            
            // Add divider if not first entry
            if (logContent.children.length > 0) {
                const divider = document.createElement('hr');
                divider.className = 'llm-log-divider';
                logContent.appendChild(divider);
            }
            
            // Create log entry
            const entry = document.createElement('div');
            entry.className = 'llm-log-entry';
            
            // Result badge
            let resultHtml = '';
            if (data.isCorrect !== null && data.isCorrect !== undefined) {
                resultHtml = `<div class="llm-log-result ${data.isCorrect ? 'correct' : 'incorrect'}">
                    ${data.isCorrect ? '‚úì CORRECT' : '‚úó INCORRECT'}
                </div>`;
            }
            
            // Grammar correction badge
            let grammarHtml = '';
            if (data.grammarIssue && data.grammarCorrection) {
                grammarHtml = `
                    <div class="llm-log-grammar">
                        <span class="grammar-label">üìù Grammar Correction:</span>
                        <span class="grammar-text">"${escapeHtml(data.grammarCorrection)}"</span>
                    </div>`;
            }
            
            entry.innerHTML = `
                <div class="llm-log-meta">
                    <div class="meta-item">
                        <span class="meta-label">üîê Auth:</span>
                        <span class="meta-value">${escapeHtml(data.authInfo)}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ü§ñ Model:</span>
                        <span class="meta-value">${escapeHtml(data.model)}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">‚è±Ô∏è Response:</span>
                        <span class="meta-value">${data.responseTime}ms</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">üéüÔ∏è Tokens:</span>
                        <span class="meta-value">~${data.tokens.input} in / ~${data.tokens.output} out (‚âà${data.tokens.total} total)</span>
                    </div>
                </div>
                <div class="llm-log-input">
                    <div class="llm-log-label">üì§ INPUT (Question ${currentQuestion + 1}):</div>
                    <div class="llm-log-text">${escapeHtml(data.prompt)}</div>
                </div>
                <div class="llm-log-output">
                    <div class="llm-log-label">üì• OUTPUT:</div>
                    <div class="llm-log-text">${escapeHtml(data.response)}</div>
                    ${resultHtml}
                    ${grammarHtml}
                </div>
            `;
            
            logContent.appendChild(entry);
            
            // Scroll to bottom
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Clear LLM log
        function clearLLMLog() {
            const logContent = document.getElementById('llmLogContent');
            logContent.innerHTML = '<div class="llm-log-empty">LLM interactions will appear here as you answer questions...<br><br>Scroll freely to review history!</div>';
        }

        // Start Quiz
        function startQuiz() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            currentQuestion = 0;
            score = 0;
            quizActive = true;

            // Reset stats and clear LLM log for new quiz
            resetStats();
            clearLLMLog();

            startScreen.style.display = 'none';
            quizScreen.style.display = 'flex';
            document.getElementById('floatingQuestion').style.display = 'block';
            resultsScreen.style.display = 'none';

            // Small delay before starting
            setTimeout(() => {
                presentQuestion();
            }, 500);
        }

        // Present Question
        function presentQuestion() {
            if (currentQuestion >= quizQuestions.length) {
                showResults();
                return;
            }

            const q = quizQuestions[currentQuestion];
            
            // Update UI
            questionText.textContent = q.question;
            questionCounter.textContent = `Question ${currentQuestion + 1} of ${quizQuestions.length}`;
            progressFill.style.width = `${((currentQuestion) / quizQuestions.length) * 100}%`;
            
            // Reset status area
            userAnswerEl.textContent = '';
            feedbackText.textContent = '';
            feedbackText.className = 'feedback-text';
            
            // Show speaking state
            setStatusState('speaking');
            
            // Speak the question
            speakText(q.question, () => {
                // After speaking, start listening
                setTimeout(() => {
                    startListening();
                }, 300);
            });
        }

        // Set Status State
        function setStatusState(state) {
            statusIcon.className = 'status-icon';
            speakerWaves.classList.add('hidden');
            waveAnimation.classList.add('hidden');
            checkIcon.classList.add('hidden');
            crossIcon.classList.add('hidden');

            switch(state) {
                case 'speaking':
                    statusIcon.classList.add('speaking');
                    speakerWaves.classList.remove('hidden');
                    statusText.textContent = 'Speaking question...';
                    break;
                case 'listening':
                    statusIcon.classList.add('listening');
                    waveAnimation.classList.remove('hidden');
                    statusText.textContent = 'Listening...';
                    break;
                case 'thinking':
                    statusIcon.classList.add('thinking');
                    statusText.textContent = 'Checking answer...';
                    break;
                case 'correct':
                    statusIcon.classList.add('correct');
                    checkIcon.classList.remove('hidden');
                    statusText.textContent = 'Correct!';
                    break;
                case 'incorrect':
                    statusIcon.classList.add('incorrect');
                    crossIcon.classList.remove('hidden');
                    statusText.textContent = 'Not quite!';
                    break;
            }
        }

        // Speak Text
        function speakText(text, callback) {
            if (synth.speaking) {
                synth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            const voices = synth.getVoices();
            const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) || 
                                 voices.find(v => v.lang.startsWith('en'));
            if (englishVoice) {
                utterance.voice = englishVoice;
            }

            utterance.onend = () => {
                if (callback) callback();
            };

            synth.speak(utterance);
        }

        // Start Listening
        function startListening() {
            if (!recognition || !quizActive || isProcessingAnswer) return;

            userAnswer = '';
            userAnswerEl.textContent = '';
            setStatusState('listening');

            let silenceTimeout;

            recognition.onresult = (event) => {
                if (isProcessingAnswer) return;
                
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript = event.results[i][0].transcript;
                }
                
                userAnswer = transcript.toLowerCase().trim();
                userAnswerEl.textContent = `"${transcript}"`;

                // Reset silence timeout on new input
                clearTimeout(silenceTimeout);
                
                // Check if this is a final result
                if (event.results[event.results.length - 1].isFinal && userAnswer) {
                    // Wait a moment for user to finish speaking, then process
                    silenceTimeout = setTimeout(() => {
                        if (!isProcessingAnswer && quizActive && userAnswer) {
                            isProcessingAnswer = true;
                            try {
                                recognition.stop();
                            } catch(e) {}
                            checkAnswer();
                        }
                    }, 1200);
                }
            };

            recognition.onerror = (event) => {
                // Silently handle errors - no console spam
                if (event.error === 'aborted' || event.error === 'no-speech') {
                    // These are expected, ignore them
                    return;
                }
            };

            recognition.onend = () => {
                clearTimeout(silenceTimeout);
                // Only restart if we're still in listening mode and haven't processed an answer
                if (quizActive && !isProcessingAnswer) {
                    setTimeout(() => {
                        if (quizActive && !isProcessingAnswer) {
                            try {
                                recognition.start();
                            } catch(e) {}
                        }
                    }, 100);
                }
            };

            try {
                recognition.start();
            } catch (e) {
                // Already started, ignore
            }
        }
        
        // Stop listening completely
        function stopListening() {
            try {
                recognition.onend = null;
                recognition.onresult = null;
                recognition.onerror = null;
                recognition.stop();
            } catch(e) {}
        }

        // Check Answer using Free LLM (Puter.js - no API key needed!)
        async function checkAnswer() {
            const q = quizQuestions[currentQuestion];
            
            setStatusState('thinking');
            statusText.textContent = 'Checking grammar...';
            
            let isCorrect = false;
            let grammarCorrection = null;
            let hasGrammarIssue = false;
            
            const prompt = `You are a quiz answer validator and grammar checker. 

Question: "${q.question}"
Correct answer: "${q.answer}"
User's spoken answer: "${userAnswer}"

Task 1 - Check grammar FIRST:
- Is the user's spoken answer grammatically correct?
- IMPORTANT: Do NOT mark as wrong for missing punctuation (periods, commas, question marks, etc.)
- IMPORTANT: Do NOT mark as wrong for capitalization issues
- Only mark grammar as WRONG for actual grammatical errors like wrong verb tense, subject-verb disagreement, wrong word order, missing words, etc.
- If not, provide the corrected version with proper grammar

Task 2 - Check if the answer is correct:
- Consider semantic equivalence (e.g., "8" = "eight")
- Accept partial matches that show understanding
- Ignore minor speech recognition errors
- Ignore filler words like "I think it's..." or "The answer is..."

Respond in this EXACT format (3 lines only):
GRAMMAR: OK or WRONG
CORRECTION: [corrected sentence with proper grammar, or "none" if grammar is OK]
ANSWER: CORRECT or INCORRECT`;
            
            // Get auth info for logging
            let authInfo = 'Anonymous (free tier)';
            try {
                if (puter.auth.isSignedIn()) {
                    const user = await puter.auth.getUser();
                    authInfo = `Logged in: ${user.username}`;
                }
            } catch(e) {}
            
            const modelInfo = 'gpt-4o-mini';
            const startTime = Date.now();
            
            try {
                // Using Puter.js free LLM - explicitly using GPT-4o mini model
                const response = await puter.ai.chat(
                    prompt,
                    { model: 'gpt-4o-mini' }
                );
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                const resultText = (response?.message?.content || response || '').toString();
                
                // Parse the response
                const lines = resultText.split('\n').map(l => l.trim()).filter(l => l);
                
                // Check grammar FIRST
                const grammarLine = lines.find(l => l.toUpperCase().startsWith('GRAMMAR:')) || '';
                hasGrammarIssue = grammarLine.toUpperCase().includes('WRONG');
                
                // Get correction if any
                const correctionLine = lines.find(l => l.toUpperCase().startsWith('CORRECTION:')) || '';
                if (hasGrammarIssue && correctionLine) {
                    grammarCorrection = correctionLine.replace(/^CORRECTION:\s*/i, '').trim();
                    if (grammarCorrection.toLowerCase() === 'none') {
                        grammarCorrection = null;
                    }
                }
                
                // Check answer correctness
                const answerLine = lines.find(l => l.toUpperCase().startsWith('ANSWER:')) || '';
                isCorrect = answerLine.toUpperCase().includes('CORRECT') && !answerLine.toUpperCase().includes('INCORRECT');
                
                // Estimate token usage (rough estimate)
                const inputTokens = Math.ceil(prompt.length / 4);
                const outputTokens = Math.ceil(resultText.length / 4);
                const totalTokens = inputTokens + outputTokens;
                
                // Log to the LLM panel with all info
                logLLMInteraction({
                    prompt: prompt,
                    response: resultText,
                    isCorrect: isCorrect,
                    authInfo: authInfo,
                    model: modelInfo,
                    responseTime: responseTime,
                    tokens: { input: inputTokens, output: outputTokens, total: totalTokens },
                    grammarIssue: hasGrammarIssue,
                    grammarCorrection: grammarCorrection
                });
                
                console.log('LLM Model: gpt-4o-mini via Puter.js');
                console.log('LLM Response:', response);
                
            } catch (error) {
                console.error('LLM check failed, using fallback:', error);
                
                // Fallback to simple string matching
                isCorrect = q.acceptedAnswers.some(accepted => 
                    userAnswer.includes(accepted) || accepted.includes(userAnswer)
                );
                
                // Log fallback
                logLLMInteraction({
                    prompt: `[FALLBACK - String Match]\nQuestion: "${q.question}"\nUser answer: "${userAnswer}"`,
                    response: `API Error: ${error.message}\nUsing simple string matching.\nResult: ${isCorrect ? 'CORRECT' : 'INCORRECT'}`,
                    isCorrect: isCorrect,
                    authInfo: authInfo,
                    model: 'Fallback (no LLM)',
                    responseTime: 0,
                    tokens: { input: 0, output: 0, total: 0 },
                    grammarIssue: false,
                    grammarCorrection: null
                });
            }

            // STEP 1: If grammar issue, tell user FIRST
            if (hasGrammarIssue && grammarCorrection) {
                setStatusState('thinking');
                feedbackText.textContent = `üìù Grammar: "${grammarCorrection}"`;
                feedbackText.className = 'feedback-text';
                
                // Speak grammar correction first, then check answer
                speakText(`Your grammar needs improvement. You said: "${userAnswer}". The correct way to say it is: "${grammarCorrection}".`, () => {
                    // Small pause before giving answer feedback
                    setTimeout(() => {
                        giveAnswerFeedback(isCorrect, q);
                    }, 500);
                });
            } else {
                // No grammar issue, go straight to answer feedback
                giveAnswerFeedback(isCorrect, q);
            }
        }
        
        // Give answer feedback (correct or incorrect)
        function giveAnswerFeedback(isCorrect, q) {
            if (isCorrect) {
                score++;
                setStatusState('correct');
                feedbackText.textContent = `‚úì ${q.answer}`;
                feedbackText.className = 'feedback-text correct';
                speakText(`Correct! The answer is ${q.answer}.`, () => {
                    moveToNextQuestion();
                });
            } else {
                setStatusState('incorrect');
                feedbackText.textContent = `‚úó Answer: ${q.answer}`;
                feedbackText.className = 'feedback-text incorrect';
                speakText(`Not quite. The correct answer is ${q.answer}.`, () => {
                    moveToNextQuestion();
                });
            }
        }

        // Move to Next Question
        function moveToNextQuestion() {
            currentQuestion++;
            isProcessingAnswer = false;
            
            if (currentQuestion >= quizQuestions.length) {
                setTimeout(() => {
                    showResults();
                }, 1000);
            } else {
                setTimeout(() => {
                    presentQuestion();
                }, 1500);
            }
        }

        // Show Results
        function showResults() {
            quizActive = false;
            isProcessingAnswer = false;
            stopListening();
            
            // Update floating question area to show results instead
            const floatingQuestion = document.getElementById('floatingQuestion');
            floatingQuestion.innerHTML = `
                <div class="results-inline">
                    <div class="results-score">${score}/${quizQuestions.length}</div>
                    <div class="results-label">Final Score</div>
                    <div class="results-message" id="inlineScoreMessage"></div>
                    <button class="restart-btn-inline" onclick="restartQuiz()">Play Again</button>
                </div>
            `;
            
            let message = '';
            const percentage = (score / quizQuestions.length) * 100;
            
            if (percentage === 100) {
                message = "Perfect! üéâ";
            } else if (percentage >= 80) {
                message = "Excellent! ‚≠ê";
            } else if (percentage >= 60) {
                message = "Good job! üëç";
            } else if (percentage >= 40) {
                message = "Keep practicing! üí™";
            } else {
                message = "Try again! üåü";
            }

            document.getElementById('inlineScoreMessage').textContent = message;

            speakText(`Quiz complete! You scored ${score} out of ${quizQuestions.length}. ${message.replace(/[^\w\s!]/g, '')}`);
        }

        // View LLM History from results screen
        function viewHistory() {
            resultsScreen.style.display = 'none';
            // Quiz screen with LLM log is still visible
        }

        // Restart Quiz
        function restartQuiz() {
            synth.cancel();
            stopListening();
            isProcessingAnswer = false;
            
            // Restore floating question HTML
            const floatingQuestion = document.getElementById('floatingQuestion');
            floatingQuestion.innerHTML = `
                <div class="question-counter" id="questionCounter">Question 1 of 5</div>
                <div class="question-text" id="questionText"></div>
                <div class="status-area">
                    <div class="status-icon" id="statusIcon">
                        <div class="speaker-waves" id="speakerWaves">
                            <div class="speaker-wave"></div>
                            <div class="speaker-wave"></div>
                            <div class="speaker-wave"></div>
                            <div class="speaker-wave"></div>
                            <div class="speaker-wave"></div>
                        </div>
                        <div class="wave-animation hidden" id="waveAnimation">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                        <svg id="checkIcon" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="#4ade80">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        <svg id="crossIcon" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="#f87171">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </div>
                    <div class="status-info">
                        <div class="status-text" id="statusText">Speaking question...</div>
                        <div class="user-answer" id="userAnswer"></div>
                        <div class="feedback-text" id="feedbackText"></div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            `;
            
            quizScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            startScreen.style.display = 'flex';
        }

        // Load voices
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                synth.getVoices();
            };
        }

        // Preload voices
        window.addEventListener('load', () => {
            synth.getVoices();
            checkAuthStatus();
        });
        
        // Check Puter authentication status
        async function checkAuthStatus() {
            const statusDot = document.getElementById('statusDot');
            const userInfo = document.getElementById('userInfo');
            const authBtn = document.getElementById('authBtn');
            
            try {
                const isSignedIn = puter.auth.isSignedIn();
                
                if (isSignedIn) {
                    const user = await puter.auth.getUser();
                    statusDot.className = 'status-dot online';
                    userInfo.textContent = `Logged in: ${user.username}`;
                    authBtn.textContent = 'Sign Out';
                    authBtn.className = 'auth-btn sign-out';
                    llmStats.authInfo = `${user.username}`;
                } else {
                    statusDot.className = 'status-dot offline';
                    userInfo.textContent = 'Not logged in (using free tier)';
                    authBtn.textContent = 'Sign In';
                    authBtn.className = 'auth-btn';
                    llmStats.authInfo = 'Anonymous (free tier)';
                }
                updateStatsBar();
            } catch (error) {
                console.error('Auth check error:', error);
                statusDot.className = 'status-dot offline';
                userInfo.textContent = 'Auth status unknown';
                llmStats.authInfo = 'Unknown';
                updateStatsBar();
            }
        }
        
        // Toggle sign in / sign out
        async function toggleAuth() {
            try {
                const isSignedIn = puter.auth.isSignedIn();
                
                if (isSignedIn) {
                    await puter.auth.signOut();
                } else {
                    await puter.auth.signIn();
                }
                
                // Refresh status after auth change
                await checkAuthStatus();
            } catch (error) {
                console.error('Auth toggle error:', error);
            }
        }
    </script>
</body>
</html>
